<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Treinos Cadastrados</title>

  <link rel="stylesheet" href="/ngl/css/index.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
  <script src="/ngl/js/session.js"></script>

  <style>
    .download .box-container{
      display:flex; flex-wrap:wrap; gap:2rem; justify-content:center;
      padding:2rem 0; max-width:100%; overflow-x:auto;
    }
    .download .box{
      border:2px solid #333; box-shadow:0 4px 8px rgba(0,0,0,.1);
      border-radius:.5rem; text-align:center; padding:1.5rem; margin:1rem;
      background:#1a1a1a; color:#ddd; transition:.3s; overflow-x:auto;
      width:100%; max-width:1200px;
    }
    .download .box h2{ font-size:2rem; margin-bottom:1.5rem; }
    .download .group-title{ font-size:1.5rem; margin-top:1.5rem; color:#00aaff; text-align:left; }
    .download .treino-card{
      display:flex; flex-direction:column; border:1px solid #ddd; padding:10px;
      margin-bottom:10px; background:#2a2a2a; border-radius:5px; color:#fff;
      cursor:pointer; transition:background-color .3s;
    }
    .download .treino-card div{ margin-bottom:5px; }
    .download .treino-card div span{ font-weight:700; }
    .download .treino-card div span.nome{ color:#00aaff; }
    .download .treino-card div span.repeticao{ color:#ff6347; }
    .download .treino-card div span.observacao{ color:#ffa500; }
    .download .treino-card.active{ background:#4CAF50 !important; }
    @media (max-width:600px){ .download .box{ padding:1rem; margin:.5rem; } }
  </style>
</head>
<body>
  <!-- NAVBAR via fetch -->
  <div id="navbar-root"></div>
  <script>
    (function(){
      const target = document.getElementById('navbar-root');
      fetch('/ngl/frontend/navbar.html?v=3')
        .then(r => { if(!r.ok) throw new Error('Navbar não encontrada: '+r.status); return r.text(); })
        .then(html => target.outerHTML = html)
        .catch(err => { console.error(err); target.outerHTML = '<div style="color:#f66;padding:10px">Falha ao carregar o menu.</div>'; });
    })();
  </script>

  <main>
    <div class="download">
      <div class="box-container">
        <div class="box">
          <h2>Treinos Cadastrados</h2>
          <div id="treino-cards"></div>
        </div>
      </div>
    </div>
  </main>

  <script>
    const API = '/ngl/backend/ver_treinos.php';

    function loadTreinos(){
      $.ajax({
        url: API,
        method: 'GET',
        dataType: 'json'
      })
      .done(function(treinos){
        const cards = $('#treino-cards').empty();
        const grupos = {};
        (treinos || []).forEach(t => {
          if(!grupos[t.grupo]) grupos[t.grupo] = [];
          grupos[t.grupo].push(t);
        });

        Object.keys(grupos).sort().forEach(grupo=>{
          cards.append('<div class="group-title">GRUPO '+ grupo +'</div>');
          grupos[grupo].forEach(t=>{
            const ativo = (t.estado === 'ativo') ? 'active' : '';
            cards.append(
              '<div class="treino-card '+ativo+'" data-id="'+t.id+'" onclick="toggleColor(this)">'+
                '<div><span class="parte">Parte:</span> '+ (t.parte||'') +'</div>'+
                '<div><span class="nome">Nome:</span> '+ (t.nome||'') +'</div>'+
                '<div><span class="series">Séries:</span> '+ (t.series||'') +'</div>'+
                '<div><span class="repeticao">Repetições:</span> '+ (t.repeticao||'') +'</div>'+
                '<div><span class="observacao">Observação:</span> '+ (t.observacao||'') +'</div>'+
              '</div>'
            );
          });
        });

        if(Object.keys(grupos).length === 0){
          cards.html('<div style="padding:.8rem;background:#1e1e1e;border:1px solid #333;border-radius:.5rem;color:#bbb">Nenhum treino cadastrado.</div>');
        }
      })
      .fail(function(xhr){
        if (xhr.status === 401) location.href = '/ngl/frontend/login.html';
        else alert('Erro ao listar treinos ('+xhr.status+').');
      });
    }

    function toggleColor(el){
      const id = $(el).data('id');
      const estado = el.classList.contains('active') ? 'normal' : 'ativo';

      // feedback imediato
      if (estado === 'ativo') el.classList.add('active'); else el.classList.remove('active');

      $.ajax({
        url: API,
        method: 'POST',
        dataType: 'json',
        data: { action:'toggle', id_treino:id, estado:estado }
      })
      .done(function(resp){
        if (!resp || resp.status !== 'success') {
          // reverte se falhar
          if (estado === 'ativo') el.classList.remove('active'); else el.classList.add('active');
          console.error('Erro ao atualizar estado:', resp && resp.message);
        }
      })
      .fail(function(xhr){
        // reverte no erro
        if (estado === 'ativo') el.classList.remove('active'); else el.classList.add('active');
        if (xhr.status === 401) location.href = '/ngl/frontend/login.html';
        else alert('Erro ao atualizar estado ('+xhr.status+').');
      });
    }

    $(function(){
      if (typeof checkUserStatus === 'function') checkUserStatus(false, loadTreinos);
      else loadTreinos();
    });
  </script>
</body>
</html>
