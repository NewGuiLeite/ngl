<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consulta de Pessoas</title>
    <link rel="stylesheet" href="../css/index.css">
    <link rel="stylesheet" href="../css/consulta_pessoas.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js"></script>
    <script src="../js/session.js"></script>
    <style>
        .filtros { display:grid; gap:8px; grid-template-columns: repeat(4, minmax(160px,1fr)); margin-bottom:10px }
        .filtros .acao { display:flex; align-items:end; gap:8px }
        #totais { margin: 6px 0 10px }
    </style>
</head>
<body>
    <nav class="navbar">
        <ul class="navbar-nav">
            <li class="nav-item logo">
                <a href="#" class="nav-link">
                    <i class="fas fa-code fa-3x"></i>
                    <span class="link-text">ngL.</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../frontend/index.html" class="nav-link">
                    <i class="fas fa-home fa-3x"></i>
                    <span class="link-text">Início</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="../frontend/treino.html" class="nav-link">
                    <i class="fas fa-dumbbell fa-3x"></i>
                    <span class="link-text">Cad Treino</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../frontend/ver_treinos.html" class="nav-link">
                    <i class="fas fa-dumbbell fa-3x"></i>
                    <span class="link-text">Treino</span>
                </a>
            </li>

            <li class="nav-item">
                <a href="../frontend/consulta_pessoas.html" class="nav-link">
                    <i class="fas fa-search fa-3x"></i>
                    <span class="link-text">Consulta</span>
                </a>
            </li>

            <li class="nav-item" id="admin-link" style="display: none;">
                <a href="../frontend/usuario.html" class="nav-link">
                    <i class="fas fa-users fa-3x"></i>
                    <span class="link-text">Usuários</span>
                </a>
            </li>
            <li class="nav-item">
                <a href="../backend/logout.php" class="nav-link">
                    <i class="fas fa-sign-out-alt fa-3x"></i>
                    <span class="link-text">Logout</span>
                </a>
            </li>
        </ul>
    </nav>

    <main>
        <div class="download">
            <div class="box-container">
                <div class="box">
                    <h2>Consulta por Nome ou CPF</h2>

                    <div class="filtros">
                        <div>
                            <label for="f-cpf">CPF</label>
                            <input id="f-cpf" type="text" placeholder="ex: 00000000272">
                        </div>
                        <div>
                            <label for="f-nome">Nome</label>
                            <input id="f-nome" type="text" placeholder="parte do nome">
                        </div>
                        <div class="acao">
                            <button id="btn-buscar" class="all-btn">Buscar</button>
                            <button id="btn-limpar" class="all-btn" type="button">Limpar</button>
                        </div>
                    </div>

                    <div id="totais"></div>

                    <div id="contas-cards">
                        <!-- Cards de pessoas aparecem aqui -->
                    </div>

                    <div style="margin-top:10px;">
                        <button id="btn-mais" class="all-btn">Carregar mais</button>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        let offset = 0, limit = 100;
      
        function esc(s){ return (s ?? '').toString()
          .replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
      
        function renderCards(lista, append=false){
          const box = $('#contas-cards');
          if(!append) box.empty();
          if(!lista || !lista.length){
            if(!append) box.html('<p>Nenhum resultado.</p>');
            return;
          }
          lista.forEach(r=>{
            const cpf    = r.cpf    ?? r.CPF    ?? r[0] ?? '';
            const nome   = r.nome   ?? r.Nome   ?? r[1] ?? '';
            const genero = r.genero ?? r.Genero ?? r[2] ?? '';
            const dt     = r.dt_nasc?? r.dtNasc ?? r[3] ?? '';
            box.append(
              '<div class="treino-card">' +
                '<div><span>CPF:</span> ' + esc(cpf) + '</div>' +
                '<div><span>Nome:</span> ' + esc(nome) + '</div>' +
                '<div><span>Gênero:</span> ' + esc(genero) + '</div>' +
                '<div><span>Data de Nascimento:</span> ' + esc(dt) + '</div>' +
              '</div>'
            );
          });
        }
      
        function loadPessoas(reset=false){
  if(reset){ offset = 0; $('#contas-cards').empty(); }

  $.get('../backend/consulta_pessoas.php', {
    cpf:  $('#f-cpf').val().trim(),
    nome: $('#f-nome').val().trim(),
    limit, offset
  }, function(rows){
    // rows já é um array de objetos {cpf, nome, genero, dt_nasc}
    const box = $('#contas-cards');
    rows.forEach(p=>{
      box.append(
        '<div class="treino-card">' +
          '<div><span>CPF:</span> ' + (p.cpf||'') + '</div>' +
          '<div><span>Nome:</span> ' + (p.nome||'') + '</div>' +
          '<div><span>Gênero:</span> ' + (p.genero||'') + '</div>' +
          '<div><span>Data de Nascimento:</span> ' + (p.dt_nasc||'') + '</div>' +
        '</div>'
      );
    });
    offset += rows.length;
    $('#totais').text('Resultados carregados: ' + offset);
  }, 'json').fail(function(xhr){
    console.error(xhr.responseText);
    alert('Erro ao consultar. Confira se está logado.');
  });
}

      </script>
      
</body>
</html>
